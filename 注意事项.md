
# STM32风险计算节点通信协议规范

## 1. 概述

本文档规定了与STM32风险计算节点进行通信的数据格式和注意事项。所有通信均通过UART进行，波特率为`115200`。数据包以特定前缀的JSON字符串形式发送，并以回车换行符 `\r\n` 作为明确的结束标志。

系统支持两种类型的指令：`param`（用于更新模型参数）和 `data`（用于发送计算数据）。

---

## 2. `param` 指令 (参数更新)

### 2.1 功能描述

用于在线更新并持久化存储在STM32 Flash中的风险模型参数。可以一次性更新一个或多个参数。更新成功后，参数将立即写入Flash，并在下次设备重启后依然有效。

### 2.2 格式定义

指令由前缀 `param`、一个无空格紧跟的JSON对象和结束符 `\r\n` 组成。

**结构**: `param{JSON_OBJECT}\r\n`

**关键点**: JSON对象中的所有参数值 **必须以字符串形式** 提供。

### 2.3 字段说明

以下是所有支持更新的参数键名（`key`）：

| 分类 | 键名 (Key) | 描述 | 值类型 (Value) |
| :--- | :--- | :--- | :--- |
| **设备信息** | `station_id` | 站点ID | 字符串 (如 `"1.0"`) |
| | `location` | 位置信息 | 字符串 (如 `"1.0"`) |
| **基础风险** | `overflow_base` | 漫堤基础风险值 | 字符串 (如 `"0.15"`) |
| | `instability_base` | 失稳基础风险值 | 字符串 (如 `"0.12"`) |
| **漫堤权重** | `w_overflow_wave_height` | 漫堤风险中浪高的权重 | 字符串 (如 `"0.35"`) |
| | `w_overflow_water_level` | 漫堤风险中水位的权重 | 字符串 (如 `"0.45"`) |
| **失稳权重** | `w_instability_wave_height` | 失稳风险中浪高的权重 | 字符串 (如 `"0.30"`) |
| | `w_instability_water_level` | 失稳风险中水位的权重 | 字符串 (如 `"0.40"`) |
| **溃口权重** | `w_breach_overflow` | 溃口风险中漫堤的权重 | 字符串 (如 `"0.60"`) |
| | `w_breach_instability` | 溃口风险中失稳的权重 | 字符串 (如 `"0.40"`) |
| **综合权重** | `w_total_overflow` | 综合风险中漫堤的权重 | 字符串 (如 `"0.55"`) |
| | `w_total_breach` | 综合风险中溃口的权重 | 字符串 (如 `"0.45"`) |
| **归一化** | `norm_wave_height_L` | 浪高归一化下限 (L) | 字符串 (如 `"4.4"`) |
| | `norm_wave_height_U` | 浪高归一化上限 (U) | 字符串 (如 `"5.5"`) |
| | `norm_water_level_L` | 水位归一化下限 (L) | 字符串 (如 `"5.8"`) |
| | `norm_water_level_U` | 水位归一化上限 (U) | 字符串 (如 `"6.7"`) |
| **风险阈值** | `threshold_low` | 低风险阈值 | 字符串 (如 `"0.3"`) |
| | `threshold_medium` | 中风险阈值 | 字符串 (如 `"0.6"`) |
| | `threshold_high` | 高风险阈值 | 字符串 (如 `"0.8"`) |

### 2.4 发送示例

更新漫堤基础风险和高风险阈值：

param{"overflow_base":"0.2", "threshold_high":"0.85"}\r\n

---

## 3. `data` 指令 (数据计算)

### 3.1 功能描述

用于发送一个或多个时间点的环境数据（如浪高、水位），以触发STM32进行风险计算。数据采用分包（帧）传输，形成一个完整的批次（Batch）。

### 3.2 格式定义

指令由前缀 `data`、一个无空格紧跟的JSON对象和结束符 `\r\n` 组成。

**结构**: `data{JSON_OBJECT}\r\n`

### 3.3 字段说明

| 键名 (Key) | 描述 | 值类型 (Value) |
| :--- | :--- | :--- |
| `batch_id` | **批次唯一标识符**。同一批次的所有帧此ID必须相同。 | 字符串 |
| `station_id` | 站点ID。 | 字符串 |
| `frame_index` | **帧索引**。从 `0` 开始的整数，标识当前帧在批次中的位置。 | 数字 |
| `total_frames` | **批次总帧数**。同一批次的所有帧此值必须相同。 | 数字 |
| `payload` | **数据负载**。包含该时间点具体数据的JSON对象。 | JSON对象 |
| ├ `timestamp` | 时间戳字符串 (建议使用ISO 8601格式)。 | 字符串 |
| ├ `wave_height` | 浪高数据对象。 | JSON对象 |
| │ ├ `min` | 浪高最小值。 | 数字 |
| │ └ `max` | 浪高最大值。 | 数字 |
| └ `water_level` | 水位数据对象。 | JSON对象 |
|   ├ `min` | 水位最小值。 | 数字 |
|   └ `max` | 水位最大值。 | 数字 |

### 3.4 发送示例

一个包含7帧数据的批次中的第1帧（索引为0）：

data{"batch_id":"batch-1674100000","station_id":"S01","frame_index":0,"total_frames":7,"payload":{"timestamp":"2026-01-19T12:00:00Z","wave_height":{"min":4.5,"max":4.8},"water_level":{"min":6.0,"max":6.1}}}\r\n

---

## 4. 通用发送注意事项

1.  **结束符**: **必须** 使用 `\r\n` (回车+换行, CRLF) 作为每个数据包的结束符。这是STM32判断数据包接收完成的唯一依据。

2.  **前缀格式**: 指令前缀 (`param` 或 `data`) 与紧随其后的 `{` 之间 **不能有任何空格**。

3.  **JSON有效性**: 发送的JSON字符串必须是严格有效的。任何格式错误（如缺少逗号、括号不匹配）都会导致STM32解析失败。

4.  **`param`值的类型**: 再次强调，`param`指令的所有值都 **必须是字符串** (用双引号包裹)，即使它们代表的是数字。例如，应发送 `"0.5"` 而不是 `0.5`。

5.  **`data`批次逻辑**:
    *   一个批次的数据发送 **必须从 `frame_index: 0` 开始**。
    *   一个批次内的所有帧，其 `batch_id` 和 `total_frames` 字段必须完全一致。
    *   `total_frames` 的值必须准确反映该批次的总帧数。
    *   当前固件支持的最大帧数为 `24` (`MAX_FRAMES_PER_BATCH`)。`total_frames` 的值不应超过此限制。

6.  **发送超时**: STM32内置一个5秒的接收超时定时器。在发送一个数据批次时，**任意两帧之间的发送间隔不应超过5秒**，否则STM32会认为批次传输失败并中止接收。

7.  **串行发送**: STM32同一时间只能处理一个批次。请确保上一个批次已发送完毕（或已确认超时）后，再开始发送新的批次。

