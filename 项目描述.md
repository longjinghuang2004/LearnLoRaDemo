# STM32 风险计算节点项目总结

### 1. 项目定位
*   **角色**：智能台灯/风险预警系统的核心计算节点（“小脑”）。
*   **核心功能**：接收时序环境数据（波高、水位），基于可配置模型计算多维风险指数（漫堤、失稳、溃堤、综合），并输出详细报告。

### 2. 硬件与外设配置
*   **MCU**：STM32F103C8T6。
*   **UART1**：核心通信接口 (PA9/PA10)，波特率 115200，用于接收 JSON 指令和发送报告。
*   **TIM2**：通用定时器，驱动 LED 状态指示（接收数据时闪烁）。
*   **TIM3**：**超时看门狗**，配置为 5 秒超时。
    *   *配置细节*：PSC=7199, ARR=49999 (避免 16 位整型溢出)，时钟源 72MHz。
*   **Flash**：片内 Flash 最后一页 (0x0800FC00)，用于持久化存储模型参数。

### 3. 软件架构 (模块化设计)
*   **InputParser**：基于 cJSON，负责解析 `param`（参数更新）和 `data`（分包数据）两种 JSON 格式。
*   **Model**：管理全局模型参数结构体 `RiskModelParameters`，处理参数的加载、更新、默认值恢复及 Flash 读写。
*   **Algorithm**：纯数学计算层，实现 Sigmoid 归一化及加权求和逻辑，计算四种风险值的 min/max 区间。
*   **Indicator**：负责结果输出，采用**逐行打印**策略，避免大字符串导致的堆栈溢出。
*   **System/Drivers**：封装了 Serial（中断接收 + 双缓冲）、Timer、Delay 等底层驱动。

### 4. 通信协议与逻辑
*   **Param 指令**：
    *   **格式**：`param{...}`
    *   **功能**：更新权重、阈值等参数并写入 Flash。
    *   **反馈**：更新成功后，立即通过串口打印所有参数的**完整快照**，便于确认配置。
*   **Data 指令 (流式分包)**：
    *   **格式**：`data{"batch_id":..., "frame_index":..., "total_frames":..., "payload":{...}}`
    *   **逻辑**：引入**批次概念**，支持最大 24 帧/批次的数据接收。
    *   **状态机**：`STATE_IDLE` (空闲) <-> `STATE_RECEIVING` (接收中)。
    *   **容错**：具备批次 ID 校验、帧索引去重、丢包检测功能。

### 5. 关键可靠性机制
*   **超时检测**：若批次接收过程中断超过 5 秒，TIM3 中断触发，强制重置状态机，防止死锁。
*   **Flash 自愈测试**：
    *   上电读取标志位（42 为有效）。
    *   **自检逻辑**：每次启动后故意将 Flash 标志位写为无效值（41），迫使下一次上电触发“恢复出厂设置”流程，持续验证系统容错能力（已封装为函数，可按需开启/注释）。
*   **内存安全**：
    *   串口接收使用静态双缓冲区（`Serial_RxPacket` + `processing_buffer`），防止竞态条件。
    *   批次数据存储使用全局静态数组 `g_BatchBuffer`，避免动态内存分配。
    *   打印报告时不使用巨型缓冲区，而是分步打印，防止堆栈溢出。

### 6. 辅助开发工具
*   **PC 端监控程序**：
    *   **技术栈**：Python 3 + Tkinter + pyserial。
    *   **架构**：多线程（GUI 主线程 + 串口守护线程），通过 Queue 进行线程安全通信。
    *   **功能**：串口配置、日志实时显示、一键发送 Param 包、一键模拟发送 Data 批次（自动生成时序数据）。

### 7. 当前状态
系统已通过完整的闭环测试（PC 发送 -> STM32 接收/计算/存储 -> PC 显示结果），具备工业级的通信稳定性和异常恢复能力。
